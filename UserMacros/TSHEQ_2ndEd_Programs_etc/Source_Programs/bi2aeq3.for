      PROGRAM  BI2AEQ3
      IMPLICIT REAL*16 (A-H,O-Z)
      COMMON RHO1,RHO2,SW,FAKL(0:2000),TOLRD 
      OPEN(UNIT=5, STATUS='OLD', FILE='aeq3_inp')
      OPEN(UNIT=6, STATUS='UNKNOWN', FILE='aeq3_out')
      READ(5,900)  M,N,MAXH,RHO1,RHO2,ALPHA,SW,TOLRD,TOL    
  900 FORMAT(3I5/5(F20.10/),F20.10)
      WRITE (6,1000) M,N,RHO1,RHO2,ALPHA,SW,TOLRD,TOL,MAXH
      FAKL(0)=0
      NN=M+N
      DO 1 I=1,NN-1
      QI=I
    1 FAKL(I)=FAKL(I-1)+QLOG(QI)
      ALPH_0=ALPHA      
      SIZE=0
      DO WHILE (SIZE.LE.ALPHA)
      ALPH_0=ALPH_0+.01
      SIZE=REJMAX(M,N,ALPH_0)
      WRITE(6,2000) ALPH_0,NHST,SIZE
      END DO 
      NHST=0  
      ALPH_1=ALPH_0-.01
      ALPH_2=ALPH_0
   11 NHST=NHST+1
      ALPH_0=(ALPH_1+ALPH_2)/2  
      SIZE=REJMAX(M,N,ALPH_0)
      WRITE(6,2000) ALPH_0,NHST,SIZE
      IF((QABS(SIZE-ALPHA).LT.TOL).OR.(NHST.GE.MAXH)) GO TO 14
      IF(SIZE.GT.ALPHA) GO TO 12
      IF(SIZE.LT.ALPHA) GO TO 13
   12 ALPH_2=ALPH_0 
      GO TO 11 
   13 ALPH_1=ALPH_0 
      GO TO 11 
   14 ALPH_0=ALPH_1
      SIZE=REJMAX(M,N,ALPH_0)      
      WRITE(6,2000) ALPH_0,NHST,SIZE
 1000 FORMAT('M= ',I5,5X,'N= ',I5,10X,'RHO1=  ',F8.4,4X,'RHO2= ',F8.4/
     1'ALPHA= ',F6.5,6X,'SW=   ',F10.8,6X,'TOLRD= ',E112.5/
     2'TOL=   ',E12.5,6X,'MAXH= ',I6//)
 2000 FORMAT('ALPH_0= ',F12.10,10X,'NHST= ',I6,5X,'SIZE= ',F20.18)
      STOP
      END
      REAL FUNCTION REJMAX*16(M,N,ALPHA0)
      IMPLICIT REAL*16 (A-H,O-Z)
      COMMON RHO1,RHO2,SW,FAKL(0:2000),TOLRD,RHO1L,RHO2L,
     1REJPBC01(0:2000),REJPBC02(0:2000)
      DIMENSION HYP01(-1:2000),HYP02(-1:2000),IC1(0:2000),IC2(0:2000)
      NN=M+N
      RHO1L=QLOG(RHO1)
      RHO2L=QLOG(RHO2)
      OOM01L=0
      OOM02L=0
      REJPBC02(IS)=0
      DO 9 IS=1,NN-1
      IXL=MAX(0,IS-N)
      IXU=MIN(IS,M)
      IXEINS=IS*M/NN
      HYP01(IXU)=0
      HYP02(IXU)=0
      DO 2 J=1,IXU-IXL+1
      IX=IXU-J
      HL=FAKL(M)-FAKL(IX+1)-FAKL(M-IX-1)+FAKL(N)-FAKL(IS-IX-1)-
     1FAKL(N-IS+IX+1)
      HYP01(IX)=QEXP(HL+(IX+1)*RHO1L -OOM01L)
      HYP02(IX)=QEXP(HL+(IX+1)*RHO2L -OOM02L)
      HYP01(IX)=HYP01(IX)+HYP01(IX+1)
    2 HYP02(IX)=HYP02(IX)+HYP02(IX+1)
      OOM01L=OOM01L+QLOG(HYP01(IXL-1))
      OOM02L=OOM02L+QLOG(HYP02(IXL-1))
      DO 3 IX=IXL, IXU-1
      HYP01(IX)=HYP01(IX)/HYP01(IXL-1)
    3 HYP02(IX)=HYP02(IX)/HYP02(IXL-1)
      HYP01(IXL-1)=1
      HYP02(IXL-1)=1
      K=IXEINS
      IF(2*K.LT.IS.OR.RHO1.NE.1/RHO2) GOTO 300
      HRHO1K=HYP01(K)-HYP01(K+1)
      IF (HRHO1K.GE.ALPHA0) GOTO 36
  300 K1=MIN(K+7,IS,M)
   30 K2=K1-1
      HRHO1C1=HYP01(K1-1)
      HRHO2C1=HYP02(K1-1)
    5 ALPHA1=HRHO1C1-HYP01(K2)
      ALPHA2=HRHO2C1-HYP02(K2)
      IF (QMAX1(ALPHA1,ALPHA2)-ALPHA0) 6,6,7
    6 K2=K2+1
      If (K2.GT.IS) GOTO 35
      GOTO 5
    7 K2=K2-1
      IF (K2.LT.K1) GOTO 32
      K1=K1+1
      INC_L=0
      INC_R=1
   31 ALPHA1=HYP01(K1-1)-HYP01(K2)
      ALPHA2=HYP02(K1-1)-HYP02(K2)
      DELALPH1=ALPHA0-ALPHA1
      DELALPH2=ALPHA0-ALPHA2
      EXHYP11=HYP01(K1-2)-HYP01(K1-1)
      EXHYP12=HYP01(K2)-HYP01(K2+1)
      EXHYP21=HYP02(K1-2)-HYP02(K1-1)
      EXHYP22=HYP02(K2)-HYP02(K2+1)
      DET=EXHYP11*EXHYP22-EXHYP12*EXHYP21
      GAMMA1=(EXHYP22*DELALPH1-EXHYP12*DELALPH2)/DET
      GAMMA2=(EXHYP11*DELALPH2-EXHYP21*DELALPH1)/DET
      IF ((QMIN1(GAMMA1,GAMMA2).LT.0.OR.QMAX1(GAMMA1,GAMMA2).GE.1.)
     1.AND.INC_L.EQ.0.AND.INC_R.EQ.1) GOTO 33
      IF ((QMIN1(GAMMA1,GAMMA2).LT.0.OR.QMAX1(GAMMA1,GAMMA2).GE.1.)
     1.AND.INC_L.EQ.1.AND.INC_R.EQ.0) GOTO 34
      IF ((QMIN1(GAMMA1,GAMMA2).LT.0.OR.QMAX1(GAMMA1,GAMMA2).GE.1.)
     1.AND.INC_L.EQ.1.AND.INC_R.EQ.1) GOTO 35
      GOTO 39
   32 INC_L=1
      INC_R=1
      GOTO 31
   33 K1=K1-1
      K2=K2-1
      INC_L=1
      INC_R=0
      GOTO 31
   34 K2=K2+1
      INC_L=1
      INC_R=1
      GOTO 31
   35 K1=K1-1
      GOTO 30
   36 C1=K
      C2=K
      GAMMA1=ALPHA0/HRHO1K
      GAMMA2=GAMMA1
   39 IC1(IS)=K1-1
      IC2(IS)=K2+1
      P01GTC1=HYP01(IC1(IS))
      P01GEC2=HYP01(IC2(IS)-1)
      P02GTC1=HYP02(IC1(IS))
      P02GEC2=HYP02(IC2(IS)-1)
      IC1EQC2=0
      IF(IC1(IS).EQ.IC2(IS)) IC1EQC2=1
      REJPBC01(IS)=(P01GTC1-P01GEC2)*(1-IC1EQC2)
    9 REJPBC02(IS)=(P02GTC1-P02GEC2)*(1-IC1EQC2)
      ITMAX=1/SW-1
      REJMAX=0
      P2MAX=0
      P2=TOLRD
      PBRJ=RJPBNC(M,N,P2)    
      REJMAX=QMAX1(REJMAX,PBRJ)
      IF (PBRJ-REJMAX) 11,10,10  
   10 P2MAX=P2  
   11 DO 20 IT=1,ITMAX
      P2=IT*SW
      PBRJ=RJPBNC(M,N,P2)    
      REJMAX=QMAX1(REJMAX,PBRJ)
      IF (PBRJ-REJMAX) 20,12,12  
   12 P2MAX=P2
   20 CONTINUE
      P2=1-TOLRD
      PBRJ=RJPBNC(M,N,P2)    
      REJMAX=QMAX1(REJMAX,PBRJ)
      IF (PBRJ-REJMAX) 14,13,13  
   13 P2MAX=P2  
   14 CONTINUE
      RETURN
      END
      REAL FUNCTION RJPBNC*16(M,N,P2)
      IMPLICIT REAL*16 (A-H,O-Z)
      COMMON RHO1,RHO2,SW,FAKL(0:2000),TOLRD,RHO1L,RHO2L,
     1REJPBC01(0:2000),REJPBC02(0:2000)
      NN= M+N
      P1LI=RHO1*P2/(1-P2)
      P1LI=P1LI/(1+P1LI)
      P1LIL=QLOG(P1LI)
      Q1LIL=QLOG(1-P1LI)
      P1RE=RHO2*P2/(1-P2)
      P1RE=P1RE/(1+P1RE)
      P1REL=QLOG(P1RE)
      Q1REL=QLOG(1-P1RE)
      P2L=QLOG(P2)
      Q2L=QLOG(1-P2)
      RJPBNCLI=0
      RJPBNCRE=0
      DO 2 IS= 1,NN-1
      PROBSLI=0
      PROBSRE=0
      IXL= MAX(0,IS-N)
      IXU= MIN(IS,M)
      DO 1 IX=IXL,IXU
      BLIL= FAKL(N)-FAKL(IS-IX)-FAKL(N-IS+IX) +(IS-IX)*P2L+(N-IS+IX)
     1*Q2L+FAKL(M)-FAKL(IX)-FAKL(M-IX)+IX*P1LIL+(M-IX)*Q1LIL
      PROBSLI=PROBSLI+QEXP(BLIL)
      BREL= FAKL(N)-FAKL(IS-IX)-FAKL(N-IS+IX) +(IS-IX)*P2L+(N-IS+IX)
     1*Q2L+FAKL(M)-FAKL(IX)-FAKL(M-IX)+IX*P1REL+(M-IX)*Q1REL
    1 PROBSRE=PROBSRE+QEXP(BREL)
      RJPBNCLI=RJPBNCLI+REJPBC01(IS)*PROBSLI
    2 RJPBNCRE=RJPBNCRE+REJPBC02(IS)*PROBSRE
      RJPBNC=QMAX1(RJPBNCLI,RJPBNCRE)
      RETURN
      END





























      






